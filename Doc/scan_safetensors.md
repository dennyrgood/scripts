# ComfyUI Safetensor Reference Scanner

This script recursively scans directories containing ComfyUI workflow files (.png and .json) and extracts all references to `.safetensors` model files, creating a detailed CSV report.

## Features

- Scans both PNG files (with embedded workflow metadata) and JSON workflow files
- Recursively searches subdirectories
- Extracts safetensor references from all common ComfyUI node types:
  - Checkpoint loaders
  - LoRA loaders
  - VAE loaders
  - ControlNet loaders
  - UNet loaders
  - CLIP loaders
  - IPAdapter loaders
  - And more...
- Generates CSV with: filename, directory, file date, safetensor file, and node name
- Multiple references per file create multiple CSV rows

## Requirements

```bash
pip install Pillow
```

## Usage

### Basic Usage

Scan a directory recursively and create `safetensor_references.csv`:

```bash
python scan_safetensors.py /path/to/comfyui/output
```

### Specify Output File

```bash
python scan_safetensors.py /path/to/comfyui/output -o my_models.csv
```

### Non-Recursive Scan

Scan only the specified directory without subdirectories:

```bash
python scan_safetensors.py /path/to/comfyui/output --no-recursive
```

### Windows Example

```bash
python scan_safetensors.py "C:\ComfyUI\output" -o "C:\reports\models.csv"
```

## Output Format

The CSV file contains the following columns:

| Column | Description |
|--------|-------------|
| `filename` | Name of the PNG or JSON file |
| `directory` | Full path to the directory containing the file |
| `file_date` | Last modification date/time of the file |
| `safetensor_file` | Name of the referenced .safetensors file |
| `node_name` | Name/type of the ComfyUI node making the reference |

### Example Output

```csv
filename,directory,file_date,safetensor_file,node_name
workflow_001.png,C:\ComfyUI\output,2026-02-05 14:23:11,realisticVisionV60B1_v51HyperVAE.safetensors,Load Checkpoint
workflow_001.png,C:\ComfyUI\output,2026-02-05 14:23:11,add-detail-xl.safetensors,Load LoRA
workflow_002.json,C:\ComfyUI\workflows,2026-02-04 09:15:33,sdxl_vae.safetensors,Load VAE
```

## How It Works

1. **File Discovery**: Recursively finds all `.png` and `.json` files in the specified directory
2. **Workflow Extraction**:
   - For PNG files: Reads embedded workflow metadata from image info
   - For JSON files: Loads the workflow directly
3. **Reference Extraction**: Parses workflow nodes and identifies all safetensor file references
4. **CSV Generation**: Creates one row per reference with full metadata

## Supported Node Types

The script recognizes safetensor references from these common node input fields:

- `ckpt_name` - Checkpoint loaders
- `lora_name` - LoRA loaders
- `vae_name` - VAE loaders
- `control_net_name` - ControlNet loaders
- `embedding_name` - Embedding loaders
- `unet_name` - UNet loaders
- `clip_name` - CLIP loaders
- `ipadapter_file` - IPAdapter loaders
- `model_name` - Various model loaders
- `file` - Generic file inputs
- `model` - Generic model inputs

## Notes

- The script only reports `.safetensors` files (not .ckpt, .pt, .bin, etc.)
- Files that cannot be read or don't contain workflows are skipped with a warning
- Each unique safetensor reference in a file creates a separate CSV row
- The models_lst.txt is not used by the script - it's for your reference only

## Troubleshooting

**No references found:**
- Ensure your PNG files have embedded workflow metadata (generated by ComfyUI)
- Check that your JSON files are valid ComfyUI workflow files
- Verify the files actually reference .safetensors models

**Encoding errors:**
- The script uses UTF-8 encoding by default
- On Windows, you may need to specify encoding when opening the CSV in Excel

**Permission errors:**
- Ensure you have read permissions for the source directory
- Ensure you have write permissions for the output CSV location
