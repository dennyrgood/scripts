#!/usr/bin/env python3

import json
import sys
import glob
import argparse
from pathlib import Path
from PIL import Image

def main():
    parser = argparse.ArgumentParser(
        description="Extract workflow JSON from ComfyUI generated images based on metadata content."
    )
    
    # Positional: list of files or glob patterns
    parser.add_argument(
        'files', 
        nargs='*', 
        default=['**/*.*'],
        help="Files or glob patterns. Default is '**/*.*' (recursive search)"
    )
    
    # Optional search string (now searches INSIDE the JSON)
    parser.add_argument(
        '-s', '--search',
        type=str,
        help="Only process files where the workflow JSON contains this string"
    )
    
    # List-only mode
    parser.add_argument(
        '-l', '--list',
        action='store_true',
        help="Only list matching files, do not perform extraction"
    )

    args = parser.parse_args()

    # 1. Collect all potential files
    all_files = []
    for pattern in args.files:
        matched = glob.glob(pattern, recursive=True)
        all_files.extend(matched)

    # 2. Filter for valid image extensions
    valid_extensions = ('.png', '.jpg', '.jpeg', '.webp')
    candidate_files = sorted(list(set(
        f for f in all_files 
        if Path(f).is_file() and f.lower().endswith(valid_extensions)
    )))

    if not candidate_files:
        print("No image files found.")
        return

    # 3. Process/Filter by Metadata Content
    processed = 0
    extracted = 0
    matched_files = []

    search_term = args.search.lower() if args.search else None

    for filename in candidate_files:
        try:
            img = Image.open(filename)
            # Check 'workflow' or 'prompt' (ComfyUI uses both)
            workflow_raw = img.info.get('workflow') or img.info.get('prompt')
            
            if not workflow_raw:
                continue

            # If searching, check if term is in the raw string
            if search_term:
                if search_term not in workflow_raw.lower():
                    continue
            
            # If we are here, it's a match or we aren't searching
            matched_files.append((filename, workflow_raw))
            
        except Exception:
            # Skip files that can't be opened as images
            continue

    if not matched_files:
        print(f"No files found containing metadata matching: '{args.search}'")
        return

    # 4. Handle List or Extract
    if args.list:
        print(f"Found {len(matched_files)} files with matching metadata:")
        for f, _ in matched_files:
            print(f"  {f}")
        return

    for filename, workflow_raw in matched_files:
        try:
            workflow_data = json.loads(workflow_raw)
            output_filename = Path(filename).with_suffix('.json')
            
            with open(output_filename, 'w', encoding='utf-8') as f:
                json.dump(workflow_data, f, indent=2)
            
            print(f"✓ Extracted: {filename} -> {output_filename}")
            extracted += 1
            processed += 1
        except Exception as e:
            print(f"✗ Error saving {filename}: {str(e)}")

    print(f"\nSummary: Found {len(matched_files)} matches, successfully extracted {extracted} workflows.")

if __name__ == "__main__":
    main()
