#!/usr/bin/env python3

import json
import glob
import argparse
from pathlib import Path
from PIL import Image

def main():
    parser = argparse.ArgumentParser(
        description="Search for a string in PNG metadata and JSON files."
    )
    
    # Positional: list of files or glob patterns
    parser.add_argument(
        'files', 
        nargs='*', 
        default=['**/*.*'],
        help="Files or glob patterns. Default is '**/*.*' (recursive search)"
    )
    
    # Required search string
    parser.add_argument(
        '-s', '--search',
        type=str,
        required=True,
        help="Search for this string in PNG metadata or JSON file contents"
    )

    args = parser.parse_args()

    # 1. Collect all potential files
    all_files = []
    for pattern in args.files:
        matched = glob.glob(pattern, recursive=True)
        all_files.extend(matched)

    # 2. Filter for PNG and JSON files
    candidate_files = sorted(list(set(
        f for f in all_files 
        if Path(f).is_file() and f.lower().endswith(('.png', '.json'))
    )))

    if not candidate_files:
        print("No PNG or JSON files found.")
        return

    # 3. Search through files
    matched_files = []
    search_term = args.search.lower()

    for filename in candidate_files:
        try:
            if filename.lower().endswith('.png'):
                # Search in PNG metadata
                img = Image.open(filename)
                # Check 'workflow' or 'prompt' (ComfyUI uses both)
                workflow_raw = img.info.get('workflow') or img.info.get('prompt') or ''
                
                if search_term in workflow_raw.lower():
                    matched_files.append(filename)
                    
            elif filename.lower().endswith('.json'):
                # Search in JSON file contents
                with open(filename, 'r', encoding='utf-8') as f:
                    json_content = f.read()
                    
                if search_term in json_content.lower():
                    matched_files.append(filename)
                    
        except Exception:
            # Skip files that can't be processed
            continue

    # 4. Display results
    if not matched_files:
        print(f"No files found containing: '{args.search}'")
        return

    print(f"Found {len(matched_files)} files containing '{args.search}':")
    for f in matched_files:
        print(f"  {f}")

if __name__ == "__main__":
    main()
